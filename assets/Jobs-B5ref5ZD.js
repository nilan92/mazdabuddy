import{c as Z,b as le,r as n,d as me,j as e,X as ue,C as be,P as he,s as d,a as pe,e as fe,M as ge}from"./index-wYOFnSv_.js";import{g as ve}from"./ai-DAGMhh65.js";import{U as je}from"./user-Dof8t0AQ.js";import{C as Ne}from"./clock-Jz8X5CO-.js";import{C as _e}from"./circle-check-big-Bx-VhQdy.js";import{P as Y}from"./plus-CpvQv11-.js";import{T as ee}from"./trash-2-DuxUv3GP.js";import{S as we}from"./save-Dojyy-XX.js";import{u as te}from"./useQuery--EpIgSbT.js";import{R as ye}from"./refresh-ccw-dAcAs_5I.js";import{S as se}from"./search-NXddDCnH.js";const ke=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],re=Z("archive",ke);const Ce=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],Se=Z("hash",Ce);const Le=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],ae=Z("user-check",Le),qe=({jobId:c,onClose:E,onUpdate:_})=>{const{profile:M}=le(),[i,R]=n.useState(null),[v,K]=n.useState([]),[j,H]=n.useState([]),[Q,D]=n.useState([]),[N,$]=n.useState([]),[r,u]=n.useState("details"),[m,w]=n.useState(""),[y,k]=n.useState(""),[C,O]=n.useState(""),[z,X]=n.useState(""),[h,S]=n.useState(""),[o,b]=n.useState({part_id:"",quantity:1,is_custom:!1,custom_name:"",custom_price_lkr:"",custom_cost_lkr:""}),[p,L]=n.useState({description:"",hours:"",hourly_rate_lkr:"5000"}),[F,U]=n.useState(""),[V,s]=n.useState(!1),a=async t=>{try{const{data:l}=await d.from("job_cards").select("*, vehicles(*)").eq("id",c).abortSignal(t).single();if(t?.aborted)return;l&&(R(l),w(l.mileage?.toString()||""),k(l.technician_notes||""),O(l.status),X(l.assigned_technician_id||""),S(l.estimated_hours?.toString()||""));const{data:x}=await d.from("job_parts").select("*, parts(*)").eq("job_id",c).abortSignal(t);if(t?.aborted)return;x&&K(x);const{data:T}=await d.from("job_labor").select("*").eq("job_id",c).abortSignal(t);if(t?.aborted)return;T&&H(T);const{data:q}=await d.from("parts").select("*").abortSignal(t);if(t?.aborted)return;q&&D(q);const{data:P}=await d.from("profiles").select("id, full_name").abortSignal(t);if(t?.aborted)return;if(P&&$(P),M?.tenant_id){const{data:f}=await d.from("tenants").select("ai_api_key, brand_color, default_labor_rate").eq("id",M.tenant_id).single();f?.ai_api_key&&U(f.ai_api_key),f?.default_labor_rate&&L(A=>({...A,hourly_rate_lkr:f.default_labor_rate.toString()}))}}catch(l){l.name!=="AbortError"&&console.error("Error fetching job details:",l)}};n.useEffect(()=>{const t=new AbortController;return a(t.signal),()=>{t.abort()}},[c]);const g=async()=>{if(!i)return;const t={mileage:m?parseInt(m):null,technician_notes:y,status:C,assigned_technician_id:z||null,estimated_hours:h?parseFloat(h):0};if(C==="completed"&&i?.status!=="completed"){t.completed_at=new Date().toISOString();const x=v.reduce((f,A)=>f+A.quantity*(A.price_at_time_lkr||0),0),T=j.reduce((f,A)=>f+Number(A.hours)*(A.hourly_rate_lkr||1500),0),q=x+T,{data:P}=await d.from("invoices").select("id").eq("job_id",c).single();if(!P){const{error:f}=await d.from("invoices").insert({job_id:c,tenant_id:i.tenant_id,subtotal_lkr:q,tax_lkr:0,discount_lkr:0,total_amount_lkr:q,created_at:new Date().toISOString()});if(f){alert("Warning: Job marked completed, but Invoice creation failed. "+f.message);return}}}else C!=="completed"&&i?.status==="completed"&&(t.completed_at=null);const{error:l}=await d.from("job_cards").update(t).eq("id",c);l?alert(l.message):(_(),R(x=>x?{...x,...t}:null),C==="completed"&&i?.status!=="completed"?alert("Job Completed & Invoice Generated!"):alert("Job Updated Successfully!"))},J=async()=>{if(!confirm("Are you sure? Archived jobs will be hidden from the board."))return;const{error:t}=await d.from("job_cards").update({archived:!0}).eq("id",c);t?alert(t.message):(_(),E())},W=async t=>{if(t.preventDefault(),o.is_custom){const T=parseFloat(o.custom_cost_lkr)||0,q=parseFloat(o.custom_price_lkr)||0,{error:P}=await d.from("job_parts").insert({job_id:c,tenant_id:i?.tenant_id,part_id:null,quantity:o.quantity,price_at_time_lkr:q,cost_at_time_lkr:T,is_custom:!0,custom_name:o.custom_name});P?alert(P.message):(a(),b({part_id:"",quantity:1,is_custom:!1,custom_name:"",custom_price_lkr:"",custom_cost_lkr:""}));return}const{data:l,error:x}=await d.rpc("add_job_part_transaction",{p_job_id:c,p_part_id:o.part_id,p_quantity:o.quantity,p_user_id:M?.id});x?(console.error(x),alert("Transaction failed: "+x.message)):l&&!l.success?alert("Error: "+l.message):(a(),b({part_id:"",quantity:1,is_custom:!1,custom_name:"",custom_price_lkr:"",custom_cost_lkr:""}))},G=async t=>{t.preventDefault();const{error:l}=await d.from("job_labor").insert({job_id:c,tenant_id:i?.tenant_id,hours:parseFloat(p.hours),description:p.description,hourly_rate_lkr:parseFloat(p.hourly_rate_lkr)});l?alert(l.message):(a(),L(x=>({...x,description:"",hours:""})))},B=async t=>{if(!confirm("Remove this part? Stock will be returned to inventory."))return;const{error:l}=await d.rpc("remove_job_part_transaction",{p_job_part_id:t});l?alert("Error removing part: "+l.message):a()},oe=async t=>{await d.from("job_labor").delete().eq("id",t),a()},ie=async()=>{if(!F){alert("AI API Key not configured in Settings.");return}s(!0);try{const t=`${i?.vehicles?.make} ${i?.vehicles?.model} (${i?.vehicles?.license_plate})`,l=await ve(F,t,i?.description||"",y),x=y?`${y}

--- AI Suggestion ---
${l}`:`--- AI Suggestion ---
${l}`;k(x)}catch{alert("AI Error: Failed to generate diagnosis.")}finally{s(!1)}},ne=v.reduce((t,l)=>t+l.price_at_time_lkr*l.quantity,0),ce=j.reduce((t,l)=>t+l.hourly_rate_lkr*l.hours,0),I=j.reduce((t,l)=>t+l.hours,0),de=parseFloat(h)||0,xe=I>de?"text-red-400":"text-emerald-400";return i?me.createPortal(e.jsx("div",{className:"fixed inset-0 z-[9999] overflow-hidden","aria-labelledby":"slide-over-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"absolute inset-0 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity",onClick:E}),e.jsx("div",{className:"pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-0 md:pl-10",children:e.jsx("div",{className:"pointer-events-auto w-screen max-w-lg transform transition-all",children:e.jsxs("div",{className:"flex h-[100dvh] flex-col bg-slate-900 border-l border-slate-800 shadow-2xl",children:[e.jsxs("div",{className:"px-4 py-3 md:px-6 md:py-4 border-b border-slate-800 flex items-start justify-between bg-slate-950",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg md:text-xl font-black text-white",children:[i.vehicles?.make," ",i.vehicles?.model]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"bg-slate-800 text-slate-300 text-[10px] px-2 py-0.5 rounded font-mono",children:i.vehicles?.license_plate}),e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded-full uppercase font-bold
                                            ${i.status==="completed"?"bg-emerald-500/10 text-emerald-400":i.status==="in_progress"?"bg-blue-500/10 text-blue-400":"bg-slate-700 text-slate-400"}`,children:i.status.replace("_"," ")})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[i.status==="completed"&&!i.archived&&e.jsx("button",{onClick:J,className:"p-2 text-slate-400 hover:text-amber-400 hover:bg-amber-400/10 rounded-lg transition-colors",title:"Archive Job",children:e.jsx(re,{size:18})}),e.jsx("button",{onClick:E,className:"p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors",children:e.jsx(ue,{size:20})})]})]}),e.jsxs("div",{className:"flex border-b border-slate-800 bg-slate-900 z-10 sticky top-0",children:[e.jsx("button",{onClick:()=>u("details"),className:`flex-1 py-3 text-xs md:text-sm font-bold border-b-2 transition-colors ${r==="details"?"border-brand text-brand":"border-transparent text-slate-500 hover:text-white"}`,children:"Details"}),e.jsx("button",{onClick:()=>u("parts"),className:`flex-1 py-3 text-xs md:text-sm font-bold border-b-2 transition-colors ${r==="parts"?"border-brand text-brand":"border-transparent text-slate-500 hover:text-white"}`,children:"Parts"}),e.jsx("button",{onClick:()=>u("labor"),className:`flex-1 py-3 text-xs md:text-sm font-bold border-b-2 transition-colors ${r==="labor"?"border-brand text-brand":"border-transparent text-slate-500 hover:text-white"}`,children:"Labor"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-6 bg-slate-900 pb-40",children:[r==="details"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase mb-1 block",children:"Status"}),e.jsxs("select",{value:C,onChange:t=>O(t.target.value),className:"w-full bg-slate-800 text-white p-2 text-sm rounded border border-slate-700",children:[e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"waiting_parts",children:"Waiting for Parts"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase mb-1 block",children:"Technician"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:z,onChange:t=>X(t.target.value),className:"w-full bg-slate-800 text-white p-2 pl-8 text-sm rounded border border-slate-700",children:[e.jsx("option",{value:"",children:"Unassigned"}),N.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]}),e.jsx(je,{size:14,className:"absolute left-2.5 top-2.5 text-slate-400"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase mb-1 block",children:"Mileage"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",value:m,onChange:t=>w(t.target.value),className:"w-full bg-slate-800 text-white p-2 pl-8 text-sm rounded border border-slate-700",placeholder:"0"}),e.jsx(Se,{size:14,className:"absolute left-2.5 top-2.5 text-slate-400"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase mb-1 block",children:"Est. Hours"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",value:h,onChange:t=>S(t.target.value),className:"w-full bg-slate-800 text-white p-2 pl-8 text-sm rounded border border-slate-700",placeholder:"0"}),e.jsx(Ne,{size:14,className:"absolute left-2.5 top-2.5 text-slate-400"})]})]})]}),h&&e.jsxs("div",{className:"bg-slate-800/50 p-4 rounded-lg border border-slate-800",children:[e.jsx("h4",{className:"text-[10px] font-bold text-slate-500 uppercase mb-2",children:"Efficiency Tracking"}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-400",children:"Actual Hours"}),e.jsxs("div",{className:`text-xl font-bold ${xe}`,children:[I.toFixed(1)," ",e.jsxs("span",{className:"text-xs text-slate-500",children:["/ ",parseFloat(h).toFixed(1)]})]})]}),e.jsx("div",{className:"text-right",children:I>parseFloat(h)?e.jsxs("span",{className:"text-red-400 text-[10px] flex items-center gap-1",children:[e.jsx(be,{size:10})," Over"]}):e.jsxs("span",{className:"text-emerald-400 text-[10px] flex items-center gap-1",children:[e.jsx(_e,{size:10})," Good"]})})]}),e.jsx("div",{className:"w-full bg-slate-700 h-1.5 mt-3 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full ${I>parseFloat(h)?"bg-red-500":"bg-emerald-500"}`,style:{width:`${Math.min(100,I/parseFloat(h||"1")*100)}%`}})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase mb-1 block",children:"Description"}),e.jsx("textarea",{rows:2,readOnly:!0,value:i.description,className:"w-full bg-slate-900 text-slate-400 p-3 text-sm rounded border border-slate-800 focus:outline-none"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("label",{className:"text-[10px] font-bold text-slate-500 uppercase",children:"Technician Notes"}),F&&e.jsx("button",{onClick:ie,disabled:V,className:"text-[10px] bg-purple-500/10 text-purple-400 px-2 py-1 rounded hover:bg-purple-500/20 disabled:opacity-50 flex items-center gap-1 transition-colors",children:V?"Thinking...":"âœ¨ AI Assist"})]}),e.jsx("textarea",{rows:4,value:y,onChange:t=>k(t.target.value),className:"w-full bg-slate-800 text-white p-3 text-sm rounded border border-slate-700 focus:border-brand focus:outline-none",placeholder:"Add diagnosis and repair notes..."})]})]}),r==="parts"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800 p-4 rounded-xl border border-slate-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h4",{className:"font-bold text-white text-sm flex items-center gap-2",children:[e.jsx(Y,{size:16,className:"text-brand"})," Add Part"]}),e.jsxs("div",{className:"flex bg-slate-900 p-1 rounded-lg border border-slate-700",children:[e.jsx("button",{onClick:()=>b({...o,is_custom:!1}),className:`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${o.is_custom?"text-slate-500 hover:text-slate-300":"bg-cyan-600 text-white"}`,children:"Inventory"}),e.jsx("button",{onClick:()=>b({...o,is_custom:!0}),className:`px-3 py-1 text-[10px] font-bold rounded-md transition-all ${o.is_custom?"bg-cyan-600 text-white":"text-slate-500 hover:text-slate-300"}`,children:"Custom"})]})]}),e.jsx("form",{onSubmit:W,className:"space-y-3",children:o.is_custom?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{required:!0,placeholder:"Custom Part Name (e.g. Engine Oil 4L)",value:o.custom_name,onChange:t=>b({...o,custom_name:t.target.value}),className:"flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm"})}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-2 top-2 text-[10px] text-slate-500",children:"Sell Price"}),e.jsx("input",{required:!0,type:"number",placeholder:"Sell Price",value:o.custom_price_lkr,onChange:t=>b({...o,custom_price_lkr:t.target.value}),className:"w-full bg-slate-900 border border-slate-600 rounded p-2 pl-14 text-white text-xs font-mono"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("span",{className:"absolute left-2 top-2 text-[10px] text-slate-500",children:"Buy Cost"}),e.jsx("input",{required:!0,type:"number",placeholder:"Buy Cost",value:o.custom_cost_lkr,onChange:t=>b({...o,custom_cost_lkr:t.target.value}),className:"w-full bg-slate-900 border border-slate-600 rounded p-2 pl-12 text-white text-xs font-mono"})]})]}),e.jsx("input",{type:"number",min:"1",value:o.quantity,onChange:t=>b({...o,quantity:parseInt(t.target.value)}),className:"w-12 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs"}),e.jsx("button",{type:"submit",className:"btn-brand px-3 py-2 rounded font-bold text-sm whitespace-nowrap",children:"Add"})]})]}):e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("select",{required:!0,value:o.part_id,onChange:t=>b({...o,part_id:t.target.value}),className:"w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm truncate",children:[e.jsx("option",{value:"",children:"Select Part..."}),Q.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.stock_quantity," in stock)"]},t.id))]})}),e.jsx("input",{type:"number",min:"1",value:o.quantity,onChange:t=>b({...o,quantity:parseInt(t.target.value)}),className:"w-14 bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm flex-shrink-0"}),e.jsx("button",{type:"submit",className:"btn-brand px-3 py-2 rounded font-bold text-sm flex-shrink-0",children:"Add"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[v.map(t=>e.jsxs("div",{className:"flex justify-between items-center bg-slate-800/50 p-3 rounded-lg border border-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{size:16,className:t.is_custom?"text-amber-400":"text-purple-400"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-white text-sm",children:[t.is_custom?t.custom_name:t.parts?.name,t.is_custom&&e.jsx("span",{className:"ml-2 text-[8px] bg-amber-500/10 text-amber-500 border border-amber-500/20 px-1 rounded uppercase",children:"Custom"})]}),e.jsxs("div",{className:"text-xs text-slate-500",children:[t.quantity," x LKR ",t.price_at_time_lkr.toLocaleString()]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-white text-sm",children:(t.price_at_time_lkr*t.quantity).toLocaleString()}),e.jsx("button",{onClick:()=>B(t.id),className:"text-slate-600 hover:text-red-400",children:e.jsx(ee,{size:14})})]})]},t.id)),v.length===0&&e.jsx("div",{className:"text-center text-slate-600 py-4 italic text-sm",children:"No parts added."})]})]}),r==="labor"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-slate-800 p-4 rounded-xl border border-slate-700",children:[e.jsxs("h4",{className:"font-bold text-white mb-3 text-sm flex items-center gap-2",children:[e.jsx(Y,{size:16,className:"text-brand"})," Add Labor"]}),e.jsxs("form",{onSubmit:G,className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{required:!0,placeholder:"Description",value:p.description,onChange:t=>L({...p,description:t.target.value}),className:"flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm"}),e.jsx("input",{required:!0,type:"number",step:"0.5",placeholder:"Hrs",value:p.hours,onChange:t=>L({...p,hours:t.target.value}),className:"w-16 bg-slate-900 border border-slate-600 rounded p-2 text-white text-sm"})]}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("span",{className:"absolute left-2 top-2 text-[10px] text-slate-500",children:"LKR"}),e.jsx("input",{required:!0,type:"number",value:p.hourly_rate_lkr,onChange:t=>L({...p,hourly_rate_lkr:t.target.value}),className:"w-full bg-slate-900 border border-slate-600 rounded p-2 pl-8 text-white text-sm font-mono"})]}),e.jsx("button",{type:"submit",className:"btn-brand px-4 py-2 rounded font-bold text-sm",children:"Add"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[j.map(t=>e.jsxs("div",{className:"flex justify-between items-center bg-slate-800/50 p-3 rounded-lg border border-slate-800",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white text-sm",children:t.description}),e.jsxs("div",{className:"text-xs text-slate-500",children:[t.hours," hrs @ ",t.hourly_rate_lkr]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-mono text-white text-sm",children:(t.hourly_rate_lkr*t.hours).toLocaleString()}),e.jsx("button",{onClick:()=>oe(t.id),className:"text-slate-600 hover:text-red-400",children:e.jsx(ee,{size:14})})]})]},t.id)),j.length===0&&e.jsx("div",{className:"text-center text-slate-600 py-4 italic text-sm",children:"No labor entries."})]})]})]}),e.jsxs("div",{className:"p-4 bg-slate-950 border-t border-slate-800 pb-[calc(1.5rem+env(safe-area-inset-bottom))]",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"text-slate-400 text-xs font-bold uppercase",children:"Estimated Total"}),e.jsxs("div",{className:"text-xl font-black text-brand font-mono",children:["LKR ",(ne+ce).toLocaleString()]})]}),e.jsxs("button",{onClick:g,className:"w-full btn-brand py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-all active:scale-95 text-sm",children:[e.jsx(we,{size:18})," Update Job"]})]})]})})})]})}),document.body):null},Re=()=>{const{profile:c}=le(),E=pe(),[_,M]=n.useState(""),[i,R]=n.useState(!1),[v,K]=n.useState(!0),[j,H]=n.useState(null),[Q,D]=n.useState(!1),[N,$]=n.useState("SELECT"),[r,u]=n.useState({vehicle_id:"",description:"",customerName:"",customerPhone:"",vehicleMake:"",vehicleModel:"",licensePlate:""}),[m,w]=n.useState(""),[y,k]=n.useState(!1),{data:C=[],isLoading:O}=te({queryKey:["jobs"],queryFn:async()=>{const{data:s}=await d.from("job_cards").select("*, vehicles(id, make, model, license_plate), profiles(full_name)").order("created_at",{ascending:!1}).limit(50);return s||[]}}),{data:z=[],isLoading:X}=te({queryKey:["vehicles"],queryFn:async()=>{const{data:s}=await d.from("vehicles").select("*, customers(name)");return s||[]}}),h=O||X,S=()=>{E.invalidateQueries({queryKey:["jobs"]}),E.invalidateQueries({queryKey:["vehicles"]})},o=fe();n.useEffect(()=>{c?.role==="technician"&&K(!1);const s=o.state;s?.vehicleId&&(u(a=>({...a,vehicle_id:s.vehicleId})),w(s.initialPlate||""),D(!0))},[c,o]);const b=async s=>{s.preventDefault();try{let a=r.vehicle_id;if(N==="EXPRESS"){const{data:J,error:W}=await d.from("customers").insert([{name:r.customerName,phone:r.customerPhone,tenant_id:c?.tenant_id}]).select().single();if(W)throw W;const{data:G,error:B}=await d.from("vehicles").insert([{customer_id:J.id,make:r.vehicleMake,model:r.vehicleModel,license_plate:r.licensePlate.toUpperCase(),tenant_id:c?.tenant_id}]).select().single();if(B)throw B;a=G.id}if(!a)throw new Error("Please select or add a vehicle.");const{error:g}=await d.from("job_cards").insert([{vehicle_id:a,description:r.description,status:"pending",assigned_technician_id:c?.id,tenant_id:c?.tenant_id}]);if(g)throw g;D(!1),u({vehicle_id:"",description:"",customerName:"",customerPhone:"",vehicleMake:"",vehicleModel:"",licensePlate:""}),w(""),S()}catch(a){alert(a.message)}},p=(s,a)=>{s.dataTransfer.setData("jobId",a)},L=async(s,a)=>{const g=s.dataTransfer.getData("jobId");await d.from("job_cards").update({status:a}).eq("id",g),S()},F=s=>s.preventDefault(),U=C.filter(s=>{const a=s.vehicles?.make.toLowerCase().includes(_.toLowerCase())||s.vehicles?.model.toLowerCase().includes(_.toLowerCase())||s.vehicles?.license_plate.toLowerCase().includes(_.toLowerCase()),g=i?s.archived:!s.archived;let J=!0;return!v&&c?.role==="technician"&&(J=s.assigned_technician_id===c.id),a&&g&&J}),V=[{id:"pending",label:"Pending",color:"bg-slate-800 border-slate-700"},{id:"in_progress",label:"In Progress",color:"bg-blue-900/20 border-blue-900/50"},{id:"waiting_parts",label:"Waiting Parts",color:"bg-orange-900/20 border-orange-900/50"},{id:"completed",label:"Completed",color:"bg-emerald-900/20 border-emerald-900/50"}];return e.jsxs("div",{className:"h-[calc(100vh-100px)] flex flex-col",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Job Board"}),e.jsx("p",{className:"text-slate-400",children:"Drag and drop to manage workflow."})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 items-center",children:[c?.role==="technician"&&e.jsxs("button",{onClick:()=>K(!v),className:`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${v?"bg-slate-800 text-slate-400 border-slate-700":"active-link"}`,children:[e.jsx(ae,{size:16})," ",v?"All Jobs":"My Jobs"]}),e.jsxs("button",{onClick:()=>R(!i),className:`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors border ${i?"bg-amber-900/30 text-amber-400 border-amber-500/50":"bg-slate-800 text-slate-400 border-slate-700"}`,children:[e.jsx(re,{size:16})," ",i?"Archived":"Active"]}),e.jsx("button",{onClick:()=>S(),className:"p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors",children:e.jsx(ye,{size:20,className:h?"animate-spin":""})}),e.jsxs("button",{onClick:()=>D(!0),className:"flex items-center gap-2 btn-brand px-4 py-2 rounded-lg font-bold shadow-lg",children:[e.jsx(Y,{size:20})," New Job"]})]})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx(se,{className:"absolute left-3 top-3 text-slate-500",size:20}),e.jsx("input",{type:"text",placeholder:"Search by vehicle or plate...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-brand",value:_,onChange:s=>M(s.target.value)})]}),e.jsx("div",{className:"flex-1 md:overflow-x-auto overflow-y-auto",children:e.jsx("div",{className:"flex flex-col md:flex-row gap-6 md:min-w-[1000px] h-auto md:h-full pb-4",children:V.map(s=>e.jsxs("div",{className:`flex-1 rounded-xl border flex flex-col ${s.color}`,onDragOver:F,onDrop:a=>L(a,s.id),children:[e.jsxs("div",{className:"p-4 border-b border-white/5 font-bold text-white flex justify-between",children:[s.label,e.jsx("span",{className:"bg-white/10 px-2 rounded text-sm",children:U.filter(a=>a.status===s.id).length})]}),e.jsx("div",{className:"p-3 space-y-3 flex-1 overflow-y-auto",children:U.filter(a=>a.status===s.id).map(a=>e.jsxs("div",{draggable:!0,onDragStart:g=>p(g,a.id),onClick:()=>H(a.id),className:"bg-slate-900 hover:bg-slate-800 p-4 rounded-lg border border-slate-800 cursor-pointer shadow-sm hover:border-cyan-500/50 transition-all group",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:"text-xs font-mono text-brand bg-brand-soft px-1.5 py-0.5 rounded border border-brand/20",children:a.vehicles?.license_plate}),a.assigned_technician_id&&e.jsxs("div",{className:"text-xs bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded flex items-center gap-1",children:[e.jsx(ae,{size:10})," Assigned"]})]}),e.jsxs("h3",{className:"font-bold text-white mb-1",children:[a.vehicles?.make," ",a.vehicles?.model]}),e.jsx("p",{className:"text-sm text-slate-400 line-clamp-2",children:a.description}),e.jsx("div",{className:"mt-3 flex items-center justify-between text-xs text-slate-500 border-t border-slate-800 pt-2",children:e.jsx("span",{children:new Date(a.created_at).toLocaleDateString()})})]},a.id))})]},s.id))})}),e.jsxs(ge,{isOpen:Q,onClose:()=>D(!1),title:"Create New Job",children:[e.jsxs("div",{className:"flex bg-slate-950 p-1 rounded-xl mb-6 border border-slate-800",children:[e.jsx("button",{onClick:()=>$("SELECT"),className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${N==="SELECT"?"bg-brand text-white shadow-lg":"text-slate-500 hover:text-slate-300"}`,children:"SMART SEARCH"}),e.jsx("button",{onClick:()=>$("EXPRESS"),className:`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${N==="EXPRESS"?"bg-brand text-white shadow-lg":"text-slate-500 hover:text-slate-300"}`,children:"WALK-IN INTAKE"})]}),e.jsxs("form",{onSubmit:b,className:"space-y-4",children:[N==="SELECT"?e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 uppercase mb-1",children:"Select Existing Vehicle"}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"absolute left-3 top-3 text-slate-500",size:18}),e.jsx("input",{type:"text",placeholder:"Search: Customer, Plate, or Model...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-3 pl-10 text-white focus:border-brand focus:outline-none",value:m,onChange:s=>{w(s.target.value),k(!0)},onFocus:()=>k(!0)})]}),y&&m&&e.jsxs("div",{className:"absolute z-10 w-full mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl max-h-60 overflow-y-auto",children:[z.filter(s=>s.license_plate.toLowerCase().includes(m.toLowerCase())||s.make.toLowerCase().includes(m.toLowerCase())||s.model.toLowerCase().includes(m.toLowerCase())||s.customers?.name.toLowerCase().includes(m.toLowerCase())).map(s=>e.jsxs("div",{onClick:()=>{u({...r,vehicle_id:s.id}),w(`${s.license_plate} - ${s.make} ${s.model} (${s.customers?.name})`),k(!1)},className:"p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50 last:border-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("div",{className:"font-bold text-white text-sm",children:s.license_plate}),e.jsx("div",{className:"text-[10px] bg-cyan-500/10 text-cyan-400 px-1.5 py-0.5 rounded font-bold uppercase",children:s.customers?.name})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:[s.make," ",s.model]})]},s.id)),z.filter(s=>s.license_plate.toLowerCase().includes(m.toLowerCase())||s.make.toLowerCase().includes(m.toLowerCase())||s.model.toLowerCase().includes(m.toLowerCase())||s.customers?.name.toLowerCase().includes(m.toLowerCase())).length===0&&e.jsx("div",{className:"p-4 text-center text-slate-500 text-sm italic",children:"No matching vehicles found"})]})]}):e.jsxs("div",{className:"space-y-4 animate-fade-in",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"Customer Name"}),e.jsx("input",{required:!0,type:"text",placeholder:"Full Name",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-2.5 text-white text-sm focus:border-brand focus:outline-none",value:r.customerName,onChange:s=>u({...r,customerName:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"Phone Number"}),e.jsx("input",{required:!0,type:"text",placeholder:"0112...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-2.5 text-white text-sm focus:border-brand focus:outline-none font-mono",value:r.customerPhone,onChange:s=>u({...r,customerPhone:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"Make"}),e.jsx("input",{required:!0,type:"text",placeholder:"Toyota",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-2.5 text-white text-sm focus:border-brand focus:outline-none",value:r.vehicleMake,onChange:s=>u({...r,vehicleMake:s.target.value})})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"Model"}),e.jsx("input",{required:!0,type:"text",placeholder:"Vitz",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-2.5 text-white text-sm focus:border-brand focus:outline-none",value:r.vehicleModel,onChange:s=>u({...r,vehicleModel:s.target.value})})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"License Plate"}),e.jsx("input",{required:!0,type:"text",placeholder:"WP-XXX...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-2.5 text-white text-sm focus:border-brand focus:outline-none font-mono uppercase",value:r.licensePlate,onChange:s=>u({...r,licensePlate:s.target.value})})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 uppercase mb-1",children:"Service Required / Fault Description"}),e.jsx("textarea",{required:!0,rows:3,placeholder:"Describe the issues reported by the customer...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl p-3 text-white text-sm focus:border-brand focus:outline-none",value:r.description,onChange:s=>u({...r,description:s.target.value})})]}),e.jsx("button",{type:"submit",className:"w-full btn-brand py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-all",children:N==="EXPRESS"?"Register & Start Job":"Create Job Card"}),N==="SELECT"&&e.jsxs("p",{className:"text-[10px] text-center text-slate-500 uppercase font-bold tracking-widest mt-2",children:["New Customer? Switch to ",e.jsx("span",{className:"text-brand cursor-pointer font-black",onClick:()=>$("EXPRESS"),children:"Walk-In Intake"})]})]})]}),j&&e.jsx(qe,{jobId:j,onClose:()=>H(null),onUpdate:S})]})};export{Re as Jobs};
