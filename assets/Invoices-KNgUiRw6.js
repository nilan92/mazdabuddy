import{c as D,a as T,b as $,r as m,j as e,F as z,C as I,s as h}from"./index-c2uMsRJE.js";import{D as P,E as q}from"./jspdf.es.min-DWMMRYN6.js";import{u as g}from"./useQuery-CzO6MZi8.js";import{R as E}from"./refresh-ccw-Rm0fFnwF.js";import{S as U}from"./search-WKGUOpbI.js";import{C as R}from"./clock-Dc9eE_j_.js";import{C as A}from"./circle-check-big-X5d1rATy.js";const K=[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]],O=D("printer",K),J=()=>{const N=T(),{profile:i}=$(),[l,d]=m.useState(null),[c,v]=m.useState(""),[w,u]=m.useState(!1),{data:C=[],isLoading:_}=g({queryKey:["invoices"],queryFn:async()=>{const{data:s,error:t}=await h.from("invoices").select(`
                    *,
                    job_cards!inner (
                        description,
                        vehicles!inner (license_plate, make, model, year, customers!inner(name, address, phone, email)),
                        job_parts ( quantity, price_at_time_lkr, custom_name, parts(name) ),
                        job_labor ( description, hours, hourly_rate_lkr )
                    )
                `).order("created_at",{ascending:!1}).limit(50);if(t)throw t;return s?.map(o=>({id:o.id,invoiceNumber:`INV-${o.id.slice(0,8).toUpperCase()}`,customer:o.job_cards?.vehicles?.customers?.name||"Unknown",customerDetails:o.job_cards?.vehicles?.customers,vehicle:`${o.job_cards?.vehicles?.make} ${o.job_cards?.vehicles?.model} (${o.job_cards?.vehicles?.license_plate})`,vehicleDetails:o.job_cards?.vehicles,total:Number(o.total_amount_lkr)||0,status:o.status||"Unpaid",date:new Date(o.created_at).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),parts:o.job_cards?.job_parts||[],labor:o.job_cards?.job_labor||[]}))||[]}}),{data:n}=g({queryKey:["tenant"],queryFn:async()=>{if(!i?.tenant_id)return null;const{data:s}=await h.from("tenants").select("name, address, phone, email, brand_color").eq("id",i.tenant_id).single();return s},enabled:!!i?.tenant_id}),p=C.filter(s=>s.customer.toLowerCase().includes(c.toLowerCase())||s.vehicle.toLowerCase().includes(c.toLowerCase())||s.invoiceNumber.toLowerCase().includes(c.toLowerCase())||s.date.includes(c)),b=()=>N.invalidateQueries({queryKey:["invoices"]}),S=async s=>{if(!l||!window.confirm(`Are you sure you want to mark this invoice as ${s}?`))return;u(!0);const{error:t}=await h.from("invoices").update({status:s}).eq("id",l.id);if(t)alert("Failed to update status");else{const o={...l,status:s};d(o),b()}u(!1)},f=s=>{switch(s){case"Paid":return e.jsx(A,{size:14});case"Unpaid":return e.jsx(R,{size:14});default:return e.jsx(I,{size:14})}},k=s=>{const t=new q,o=i?.tenants?.brand_color||"#06b6d4";t.setFillColor(o),t.rect(0,0,210,45,"F"),t.setTextColor(255,255,255),t.setFontSize(30),t.setFont("helvetica","bold"),t.text("INVOICE",140,25),t.setFontSize(10),t.text(`#${s.invoiceNumber}`,140,33),t.setFontSize(22);const F=n?.name||"Service Center",j=t.splitTextToSize(F,110);t.text(j,20,20);const y=20+j.length*8+2;t.setFontSize(10),t.setFont("helvetica","normal"),t.text(n?.address||"",20,y),t.text(n?.phone||"",20,y+5),t.setTextColor(0,0,0);let a=70;t.setFontSize(10),t.setFont("helvetica","bold"),t.text("BILL TO:",20,a),t.setFont("helvetica","normal"),a+=5,t.text(s.customerDetails?.name||s.customer,20,a),a+=5,s.customerDetails?.address&&(t.text(s.customerDetails.address,20,a),a+=5),s.customerDetails?.phone&&t.text(s.customerDetails.phone,20,a),a=70,t.setFont("helvetica","bold"),t.text("VEHICLE DETAILS:",130,a),t.setFont("helvetica","normal"),a+=5,t.text(`${s.vehicleDetails?.make} ${s.vehicleDetails?.model}`,130,a),a+=5,t.text(s.vehicleDetails?.license_plate||"",130,a),a+=5,t.text("Date: "+s.date,130,a),t.setFontSize(10),t.setTextColor(s.status==="Paid"?"#059669":"#DC2626"),t.setFont("helvetica","bold"),t.text(`STATUS: ${s.status.toUpperCase()}`,130,a+10),t.setTextColor(0,0,0),a=105,t.setFillColor(241,245,249),t.rect(20,a,170,10,"F"),t.setFont("helvetica","bold"),t.setTextColor(50),t.text("DESCRIPTION",25,a+6.5),t.text("AMOUNT",160,a+6.5),a+=18,t.setFont("helvetica","normal"),t.setTextColor(0),s.parts.forEach(r=>{const x=r.custom_name||r.parts?.name||"Part",L=r.quantity*r.price_at_time_lkr;t.text(`${x} (x${r.quantity})`,25,a),t.text(L.toLocaleString()+".00",160,a),a+=8}),s.labor.forEach(r=>{const x=r.hours*r.hourly_rate_lkr;t.text(`${r.description} (${r.hours} hrs)`,25,a),t.text(x.toLocaleString()+".00",160,a),a+=8}),s.parts.length===0&&s.labor.length===0&&(t.text("Service Charge",25,a),t.text(s.total.toLocaleString()+".00",160,a),a+=8),a+=5,t.setDrawColor(200),t.line(20,a,190,a),a+=15,t.setFontSize(12),t.setFont("helvetica","bold"),t.text("TOTAL DUE:",120,a),t.setTextColor(o),t.text(`LKR ${s.total.toLocaleString()}`,155,a),t.setTextColor(150),t.setFontSize(8),t.text("Thank you for your business!",105,280,{align:"center"}),t.save(`${s.invoiceNumber}.pdf`)};return e.jsxs("div",{className:"p-2 h-[calc(100vh-100px)] flex flex-col",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Invoices"}),e.jsx("p",{className:"text-slate-400",children:"Manage billing and payments."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:b,className:"p-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors",children:e.jsx(E,{size:20,className:_?"animate-spin":""})})})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx(U,{className:"absolute left-3 top-3.5 text-slate-500",size:18}),e.jsx("input",{type:"text",placeholder:"Search by customer, vehicle, or date (e.g., 12/25)...",className:"w-full bg-slate-900 border border-slate-800 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-cyan-500 transition-all",value:c,onChange:s=>v(s.target.value)})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-6 h-full min-h-0",children:[e.jsx("div",{className:`w-full md:w-1/3 bg-slate-900/50 border border-slate-800 rounded-2xl p-4 overflow-y-auto ${l?"hidden md:block":"block"}`,children:e.jsxs("div",{className:"space-y-3",children:[p.map(s=>e.jsxs("div",{onClick:()=>d(s),style:l?.id===s.id?{borderColor:i?.tenants?.brand_color||"#06b6d4"}:{},className:`p-4 rounded-xl border cursor-pointer transition-all ${l?.id===s.id?"bg-slate-800":"bg-slate-800/30 border-slate-800 hover:bg-slate-800"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("div",{className:"font-bold text-white text-sm md:text-base",children:s.customer}),e.jsx("div",{className:"text-[10px] md:text-xs text-slate-500 whitespace-nowrap",children:s.date})]}),e.jsx("div",{className:"text-sm text-slate-400 mb-2",children:s.vehicle}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:`text-xs px-2 py-1 rounded font-bold uppercase flex items-center gap-1 ${s.status==="Paid"?"bg-emerald-500/10 text-emerald-400":"bg-amber-500/10 text-amber-400"}`,children:[f(s.status),s.status]}),e.jsxs("span",{className:"font-mono text-white font-bold",children:["LKR ",s.total.toLocaleString()]})]})]},s.id)),p.length===0&&e.jsx("div",{className:"text-center text-slate-500 py-10",children:"No invoices found."})]})}),e.jsx("div",{className:`w-full md:flex-1 bg-slate-900 border border-slate-800 rounded-2xl p-4 md:p-6 flex flex-col ${l?"flex":"hidden md:flex"}`,children:l?e.jsxs("div",{className:"flex-1 flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-6 border-b border-slate-800 pb-4",children:[e.jsx("button",{onClick:()=>d(null),className:"md:hidden text-slate-400 flex items-center gap-2 self-start hover:text-white transition-colors",children:"â† Back to List"}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-white mb-1",children:l.customer}),e.jsx("p",{className:"text-sm text-slate-400",children:l.vehicle}),e.jsx("p",{className:"text-xs text-slate-500 font-mono mt-1",children:l.invoiceNumber})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1 w-full md:w-auto",children:[e.jsx("label",{className:"text-[10px] text-slate-500 font-bold uppercase",children:"Payment Status"}),e.jsxs("div",{className:"flex items-center gap-2 w-full md:w-auto",children:[e.jsx("div",{className:"text-slate-400 hidden md:block",children:f(l.status)}),e.jsxs("select",{value:l.status,onChange:s=>S(s.target.value),disabled:w,className:"w-full md:w-auto bg-slate-950 border border-slate-700 text-white text-sm rounded-lg px-3 py-2 outline-none focus:border-cyan-500",children:[e.jsx("option",{value:"Unpaid",children:"Pending Payment"}),e.jsx("option",{value:"Paid",children:"Paid Fully"}),e.jsx("option",{value:"Refunded",children:"Refunded"}),e.jsx("option",{value:"Cancelled",children:"Cancelled"})]})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto mb-6 bg-slate-950 rounded-xl border border-slate-800",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"bg-slate-900 text-slate-400 text-xs uppercase font-bold sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 md:px-6 md:py-4",children:"Item / Description"}),e.jsx("th",{className:"px-3 py-3 md:px-6 md:py-4 text-right",children:"Cost"})]})}),e.jsxs("tbody",{className:"divide-y divide-slate-800 text-slate-300",children:[l.parts.map((s,t)=>e.jsxs("tr",{className:"hover:bg-slate-900/50",children:[e.jsxs("td",{className:"px-3 py-3 md:px-6 md:py-4",children:[e.jsx("div",{className:"font-medium text-white text-sm",children:s.custom_name||s.parts?.name}),e.jsxs("div",{className:"text-[10px] md:text-xs text-slate-500",children:["Part (Qty: ",s.quantity,")"]})]}),e.jsx("td",{className:"px-3 py-3 md:px-6 md:py-4 text-right font-mono text-sm",children:(s.quantity*s.price_at_time_lkr).toLocaleString()})]},`p-${t}`)),l.labor.map((s,t)=>e.jsxs("tr",{className:"hover:bg-slate-900/50",children:[e.jsxs("td",{className:"px-3 py-3 md:px-6 md:py-4",children:[e.jsx("div",{className:"font-medium text-white text-sm",children:s.description}),e.jsxs("div",{className:"text-[10px] md:text-xs text-slate-500",children:["Labor (",s.hours," hrs)"]})]}),e.jsx("td",{className:"px-3 py-3 md:px-6 md:py-4 text-right font-mono text-sm",children:(s.hours*s.hourly_rate_lkr).toLocaleString()})]},`l-${t}`)),l.parts.length===0&&l.labor.length===0&&e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-3 md:px-6 md:py-4 text-slate-500 italic",children:"No breakdown items available."}),e.jsx("td",{className:"px-3 py-3 md:px-6 md:py-4 text-right text-slate-500",children:"-"})]})]}),e.jsx("tfoot",{className:"bg-slate-900 font-bold text-white border-t border-slate-800 sticky bottom-0 z-10",children:e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-3 md:px-6 md:py-4 text-right uppercase text-[10px] md:text-xs tracking-wider text-slate-400",children:"Total Due"}),e.jsxs("td",{className:"px-3 py-3 md:px-6 md:py-4 text-right text-base md:text-lg text-emerald-400 font-mono",children:["LKR ",l.total.toLocaleString()]})]})})]})}),e.jsxs("div",{className:"flex gap-4 mt-auto",children:[e.jsxs("button",{onClick:()=>k(l),className:"flex-1 bg-cyan-600 hover:bg-cyan-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-cyan-500/20 transition-all active:scale-95",children:[e.jsx(P,{size:20})," ",e.jsx("span",{className:"hidden md:inline",children:"Download PDF"}),e.jsx("span",{className:"md:hidden",children:"PDF"})]}),e.jsx("button",{onClick:()=>window.print(),className:"px-6 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold active:scale-95 transition-all",children:e.jsx(O,{size:20})})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-slate-500 opacity-50",children:[e.jsx(z,{size:64,className:"mb-4"}),e.jsx("p",{children:"Select an invoice to view details"})]})})]})]})};export{J as Invoices};
