import{c as H,b as G,a as U,r as a,e as W,j as e,M as C,s as r}from"./index-DsvCX8kd.js";import{u as P}from"./useQuery-DJ7F4Nk1.js";import{R as X}from"./refresh-ccw-DQKp5jhp.js";import{P as A}from"./plus-DvJNUDZH.js";import{S as Z}from"./search--rddRdhG.js";import{M as ee}from"./mail-mCGR5vMS.js";import{P as E}from"./pen-CFhJRk6L.js";import{T as O}from"./trash-2-Cj_pxgt_.js";import{C as se}from"./calendar-CT0-Chvf.js";const te=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],ae=H("history",te);const le=[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]],re=H("phone",le),pe=()=>{const{profile:k}=G(),_=U(),[x,S]=a.useState(""),[D,u]=a.useState(!1),[F,h]=a.useState(!1),[R,q]=a.useState(!1),[f,b]=a.useState(null),[v,j]=a.useState(null),[y,N]=a.useState(null),[p,L]=a.useState([]),[l,d]=a.useState({name:"",phone:"",email:"",address:""}),[i,o]=a.useState({make:"",model:"",year:"",license_plate:"",color:"",vin:""}),{data:M=[],isLoading:T}=P({queryKey:["customers"],queryFn:async()=>{const{data:s,error:t}=await r.from("customers").select("*").order("created_at",{ascending:!1});if(t)throw t;return s}}),{data:w=[],isLoading:K}=P({queryKey:["vehicles"],queryFn:async()=>{const{data:s,error:t}=await r.from("vehicles").select("*");if(t)throw t;return s}}),m=()=>{_.invalidateQueries({queryKey:["customers"]}),_.invalidateQueries({queryKey:["vehicles"]})},V=T||K,z=W();a.useEffect(()=>{const s=z.state;s?.initialPlate&&(S(s.initialPlate),o(t=>({...t,license_plate:s.initialPlate,make:s.make||"",model:s.model||""})))},[z]);const I=async s=>{if(s.preventDefault(),f){const{error:t}=await r.from("customers").update(l).eq("id",f.id);t&&alert(t.message)}else{const t={...l,tenant_id:k?.tenant_id},{error:n}=await r.from("customers").insert([t]);n&&alert(n.message)}u(!1),b(null),d({name:"",phone:"",email:"",address:""}),m()},Q=async s=>{if(s.preventDefault(),!y)return;const t={...i,customer_id:y.id,tenant_id:k?.tenant_id};if(v){const{tenant_id:n,...g}=t,{error:c}=await r.from("vehicles").update(g).eq("id",v.id);c&&alert(c.message)}else{const{error:n}=await r.from("vehicles").insert([t]);n&&alert(n.message)}h(!1),j(null),o({make:"",model:"",year:"",license_plate:"",color:"",vin:""}),m()},$=async s=>{if(!confirm("Are you sure? This will delete all vehicles for this customer."))return;const{error:t}=await r.from("customers").delete().eq("id",s);t?alert(t.message):m()},J=async s=>{N(M.find(c=>c.id===s)||null),q(!0);const{data:t}=await r.from("vehicles").select("id").eq("customer_id",s),n=t?.map(c=>c.id)||[];if(n.length===0){L([]);return}const{data:g}=await r.from("job_cards").select("*, vehicles(make, model, license_plate)").in("vehicle_id",n).order("created_at",{ascending:!1});g&&L(g)},Y=M.filter(s=>s.name.toLowerCase().includes(x.toLowerCase())||s.phone.includes(x)||w.some(t=>t.customer_id===s.id&&t.license_plate.toLowerCase().includes(x.toLowerCase()))),B=async s=>{if(!confirm("Are you sure? This will permanently delete this vehicle and all its job history."))return;const{error:t}=await r.from("vehicles").delete().eq("id",s);t?alert("Error deleting vehicle: "+t.message):m()};return e.jsxs("div",{className:"p-2",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Customers"}),e.jsx("p",{className:"text-slate-400",children:"Manage clients and vehicle registries."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:m,className:"p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors",title:"Refresh",children:e.jsx(X,{size:20,className:V?"animate-spin":""})}),e.jsxs("button",{onClick:()=>{b(null),d({name:"",phone:"",email:"",address:""}),u(!0)},className:"flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-cyan-500/20",children:[e.jsx(A,{size:20})," Add Customer"]})]})]}),e.jsxs("div",{className:"relative mb-8",children:[e.jsx(Z,{className:"absolute left-3 top-3 text-slate-500",size:20}),e.jsx("input",{type:"text",placeholder:"Search by name, phone, or license plate...",className:"w-full bg-slate-950 border border-slate-800 rounded-xl py-3 pl-10 text-white focus:outline-none focus:border-cyan-500",value:x,onChange:s=>S(s.target.value)})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:V?e.jsx("div",{className:"col-span-full py-20 text-center text-slate-500",children:"Loading customer database..."}):Y.map(s=>e.jsxs("div",{className:"bg-slate-900 border border-slate-800 rounded-2xl p-6 hover:border-slate-700 transition-colors",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-xl",children:s.name[0]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:s.name}),e.jsxs("div",{className:"flex items-center gap-3 text-sm text-slate-400 mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(re,{size:14})," ",s.phone]}),s.email&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ee,{size:14})," ",s.email]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>J(s.id),className:"p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-cyan-400 transition-colors",title:"Service History",children:e.jsx(ae,{size:18})}),e.jsx("button",{onClick:()=>{b(s),d({name:s.name,phone:s.phone,email:s.email||"",address:s.address||""}),u(!0)},className:"p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors",children:e.jsx(E,{size:18})}),e.jsx("button",{onClick:()=>$(s.id),className:"p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-red-400 transition-colors",children:e.jsx(O,{size:18})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs font-bold text-slate-500 uppercase tracking-widest mb-2",children:[e.jsx("span",{children:"Registered Vehicles"}),e.jsxs("button",{onClick:()=>{N(s),j(null),o({make:"",model:"",year:"",license_plate:"",color:"",vin:""}),h(!0)},className:"text-cyan-500 hover:text-cyan-400 flex items-center gap-1",children:[e.jsx(A,{size:14})," Add Vehicle"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[w.filter(t=>t.customer_id===s.id).map(t=>e.jsxs("div",{className:"bg-slate-800/50 border border-slate-800 rounded-xl p-3 flex justify-between items-center group",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-white font-medium",children:[t.make," ",t.model]}),e.jsx("div",{className:"text-xs font-mono text-cyan-500",children:t.license_plate})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{N(s),j(t),o({make:t.make,model:t.model,year:t.year,license_plate:t.license_plate,color:t.color||"",vin:t.vin||""}),h(!0)},className:"opacity-0 group-hover:opacity-100 p-1.5 hover:bg-slate-700 rounded transition-all",children:e.jsx(E,{size:14,className:"text-slate-400"})}),e.jsx("button",{onClick:()=>B(t.id),className:"opacity-0 group-hover:opacity-100 p-1.5 hover:bg-red-500/10 rounded transition-all",children:e.jsx(O,{size:14,className:"text-red-500"})})]})]},t.id)),w.filter(t=>t.customer_id===s.id).length===0&&e.jsx("div",{className:"col-span-full py-3 text-center text-slate-600 text-xs italic bg-slate-800/30 rounded-xl border border-dashed border-slate-800",children:"No vehicles registered"})]})]})]},s.id))}),e.jsx(C,{isOpen:D,onClose:()=>u(!1),title:f?"Edit Customer":"New Customer",children:e.jsxs("form",{onSubmit:I,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Full Name *"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:l.name,onChange:s=>d({...l,name:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Phone *"}),e.jsx("input",{type:"tel",required:!0,className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:l.phone,onChange:s=>d({...l,phone:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Email"}),e.jsx("input",{type:"email",className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:l.email,onChange:s=>d({...l,email:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Address"}),e.jsx("textarea",{className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",rows:2,value:l.address,onChange:s=>d({...l,address:s.target.value})})]}),e.jsx("button",{type:"submit",className:"w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg shadow-lg",children:"Save Customer"})]})}),e.jsx(C,{isOpen:F,onClose:()=>h(!1),title:v?"Edit Vehicle":"Add New Vehicle",children:e.jsxs("form",{onSubmit:Q,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Make *"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:i.make,onChange:s=>o({...i,make:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Model *"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:i.model,onChange:s=>o({...i,model:s.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"Year"}),e.jsx("input",{type:"text",className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3",value:i.year,onChange:s=>o({...i,year:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-1",children:"License Plate *"}),e.jsx("input",{type:"text",required:!0,className:"w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 font-mono",value:i.license_plate,onChange:s=>o({...i,license_plate:s.target.value})})]})]}),e.jsx("button",{type:"submit",className:"w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg shadow-lg",children:"Save Vehicle"})]})}),e.jsx(C,{isOpen:R,onClose:()=>q(!1),title:`Service History: ${y?.name}`,children:e.jsxs("div",{className:"space-y-4 max-h-[60vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[e.jsxs("div",{className:"bg-slate-800 p-3 rounded-lg text-center",children:[e.jsx("div",{className:"text-xs text-slate-500 uppercase",children:"Jobs"}),e.jsx("div",{className:"text-xl font-bold text-white",children:p.length})]}),e.jsxs("div",{className:"bg-slate-800 p-3 rounded-lg text-center col-span-2",children:[e.jsx("div",{className:"text-xs text-slate-500 uppercase",children:"Total Value"}),e.jsxs("div",{className:"text-xl font-bold text-cyan-400",children:["LKR ",p.reduce((s,t)=>s+(t.estimated_cost_lkr||0),0).toLocaleString()]})]})]}),p.length===0?e.jsx("div",{className:"text-center text-slate-500 py-8",children:"No job history found."}):p.map(s=>e.jsxs("div",{className:"bg-slate-800/50 p-4 rounded-lg border border-slate-700",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded uppercase font-bold
                                        ${s.status==="completed"?"text-emerald-400 bg-emerald-900/30":"text-cyan-400 bg-cyan-900/30"}`,children:s.status.replace("_"," ")}),e.jsxs("span",{className:"text-xs text-slate-400 flex items-center gap-1",children:[e.jsx(se,{size:12})," ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("h4",{className:"font-bold text-white",children:[s.vehicles?.make," ",s.vehicles?.model," (",s.vehicles?.license_plate,")"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:s.description}),e.jsx("div",{className:"mt-2 pt-2 border-t border-slate-700 flex justify-end",children:e.jsxs("span",{className:"text-cyan-400 font-mono font-bold",children:["LKR ",s.estimated_cost_lkr?.toLocaleString()||0]})})]},s.id))]})})]})};export{pe as Customers};
