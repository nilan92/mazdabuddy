import{c as A,f as R,g as W,u as q,r as g,b as F,j as t,R as T,T as L,s as U}from"./index-DsvCX8kd.js";import{a as H}from"./ai-DAGMhh65.js";import{R as V,C}from"./rotate-ccw-B2RvZ68m.js";import{P as J}from"./plus-DvJNUDZH.js";const K=[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]],P=A("camera",K);const G=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],Q=A("loader-circle",G);var _={exports:{}},$=_.exports,O;function B(){return O||(O=1,(function(M,k){(function(v,x){M.exports=x(R())})($,function(y){return(function(v){var x={};function d(a){if(x[a])return x[a].exports;var o=x[a]={i:a,l:!1,exports:{}};return v[a].call(o.exports,o,o.exports,d),o.l=!0,o.exports}return d.m=v,d.c=x,d.d=function(a,o,m){d.o(a,o)||Object.defineProperty(a,o,{enumerable:!0,get:m})},d.r=function(a){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})},d.t=function(a,o){if(o&1&&(a=d(a)),o&8||o&4&&typeof a=="object"&&a&&a.__esModule)return a;var m=Object.create(null);if(d.r(m),Object.defineProperty(m,"default",{enumerable:!0,value:a}),o&2&&typeof a!="string")for(var j in a)d.d(m,j,(function(w){return a[w]}).bind(null,j));return m},d.n=function(a){var o=a&&a.__esModule?function(){return a.default}:function(){return a};return d.d(o,"a",o),o},d.o=function(a,o){return Object.prototype.hasOwnProperty.call(a,o)},d.p="",d(d.s="./src/react-webcam.tsx")})({"./src/react-webcam.tsx":(function(v,x,d){d.r(x);var a=d("react"),o=(function(){var p=function(n,e){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,s){r.__proto__=s}||function(r,s){for(var i in s)s.hasOwnProperty(i)&&(r[i]=s[i])},p(n,e)};return function(n,e){p(n,e);function r(){this.constructor=n}n.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}})(),m=function(){return m=Object.assign||function(p){for(var n,e=1,r=arguments.length;e<r;e++){n=arguments[e];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(p[s]=n[s])}return p},m.apply(this,arguments)},j=function(p,n){var e={};for(var r in p)Object.prototype.hasOwnProperty.call(p,r)&&n.indexOf(r)<0&&(e[r]=p[r]);if(p!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(p);s<r.length;s++)n.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(p,r[s])&&(e[r[s]]=p[r[s]]);return e};(function(){typeof window>"u"||(navigator.mediaDevices===void 0&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia===void 0&&(navigator.mediaDevices.getUserMedia=function(n){var e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return e?new Promise(function(r,s){e.call(navigator,n,r,s)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}))})();function w(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}var N=(function(p){o(n,p);function n(e){var r=p.call(this,e)||this;return r.canvas=null,r.ctx=null,r.requestUserMediaId=0,r.unmounted=!1,r.state={hasUserMedia:!1},r}return n.prototype.componentDidMount=function(){var e=this,r=e.state,s=e.props;if(this.unmounted=!1,!w()){s.onUserMediaError("getUserMedia not supported");return}r.hasUserMedia||this.requestUserMedia(),s.children&&typeof s.children!="function"&&console.warn("children must be a function")},n.prototype.componentDidUpdate=function(e){var r=this.props;if(!w()){r.onUserMediaError("getUserMedia not supported");return}var s=JSON.stringify(e.audioConstraints)!==JSON.stringify(r.audioConstraints),i=JSON.stringify(e.videoConstraints)!==JSON.stringify(r.videoConstraints),b=e.minScreenshotWidth!==r.minScreenshotWidth,f=e.minScreenshotHeight!==r.minScreenshotHeight;(i||b||f)&&(this.canvas=null,this.ctx=null),(s||i)&&(this.stopAndCleanup(),this.requestUserMedia())},n.prototype.componentWillUnmount=function(){this.unmounted=!0,this.stopAndCleanup()},n.stopMediaStream=function(e){e&&(e.getVideoTracks&&e.getAudioTracks?(e.getVideoTracks().map(function(r){e.removeTrack(r),r.stop()}),e.getAudioTracks().map(function(r){e.removeTrack(r),r.stop()})):e.stop())},n.prototype.stopAndCleanup=function(){var e=this.state;e.hasUserMedia&&(n.stopMediaStream(this.stream),e.src&&window.URL.revokeObjectURL(e.src))},n.prototype.getScreenshot=function(e){var r=this,s=r.state,i=r.props;if(!s.hasUserMedia)return null;var b=this.getCanvas(e);return b&&b.toDataURL(i.screenshotFormat,i.screenshotQuality)},n.prototype.getCanvas=function(e){var r=this,s=r.state,i=r.props;if(!this.video||!s.hasUserMedia||!this.video.videoHeight)return null;if(!this.ctx){var b=this.video.videoWidth,f=this.video.videoHeight;if(!this.props.forceScreenshotSourceSize){var u=b/f;b=i.minScreenshotWidth||this.video.clientWidth,f=b/u,i.minScreenshotHeight&&f<i.minScreenshotHeight&&(f=i.minScreenshotHeight,b=f*u)}this.canvas=document.createElement("canvas"),this.canvas.width=e?.width||b,this.canvas.height=e?.height||f,this.ctx=this.canvas.getContext("2d")}var l=this,c=l.ctx,h=l.canvas;return c&&h&&(h.width=e?.width||h.width,h.height=e?.height||h.height,i.mirrored&&(c.translate(h.width,0),c.scale(-1,1)),c.imageSmoothingEnabled=i.imageSmoothing,c.drawImage(this.video,0,0,e?.width||h.width,e?.height||h.height),i.mirrored&&(c.scale(-1,1),c.translate(-h.width,0))),h},n.prototype.requestUserMedia=function(){var e=this,r=this.props,s=function(f,u){var l={video:typeof u<"u"?u:!0};r.audio&&(l.audio=typeof f<"u"?f:!0),e.requestUserMediaId++;var c=e.requestUserMediaId;navigator.mediaDevices.getUserMedia(l).then(function(h){e.unmounted||c!==e.requestUserMediaId?n.stopMediaStream(h):e.handleUserMedia(null,h)}).catch(function(h){e.handleUserMedia(h)})};if("mediaDevices"in navigator)s(r.audioConstraints,r.videoConstraints);else{var i=function(f){return{optional:[{sourceId:f}]}},b=function(f){var u=f.deviceId;return typeof u=="string"?u:Array.isArray(u)&&u.length>0?u[0]:typeof u=="object"&&u.ideal?u.ideal:null};MediaStreamTrack.getSources(function(f){var u=null,l=null;f.forEach(function(S){S.kind==="audio"?u=S.id:S.kind==="video"&&(l=S.id)});var c=b(r.audioConstraints);c&&(u=c);var h=b(r.videoConstraints);h&&(l=h),s(i(u),i(l))})}},n.prototype.handleUserMedia=function(e,r){var s=this.props;if(e||!r){this.setState({hasUserMedia:!1}),s.onUserMediaError(e);return}this.stream=r;try{this.video&&(this.video.srcObject=r),this.setState({hasUserMedia:!0})}catch{this.setState({hasUserMedia:!0,src:window.URL.createObjectURL(r)})}s.onUserMedia(r)},n.prototype.render=function(){var e=this,r=this,s=r.state,i=r.props,b=i.audio;i.forceScreenshotSourceSize;var f=i.disablePictureInPicture;i.onUserMedia,i.onUserMediaError,i.screenshotFormat,i.screenshotQuality,i.minScreenshotWidth,i.minScreenshotHeight,i.audioConstraints,i.videoConstraints,i.imageSmoothing;var u=i.mirrored,l=i.style,c=l===void 0?{}:l,h=i.children,S=j(i,["audio","forceScreenshotSourceSize","disablePictureInPicture","onUserMedia","onUserMediaError","screenshotFormat","screenshotQuality","minScreenshotWidth","minScreenshotHeight","audioConstraints","videoConstraints","imageSmoothing","mirrored","style","children"]),I=u?m(m({},c),{transform:(c.transform||"")+" scaleX(-1)"}):c,E={getScreenshot:this.getScreenshot.bind(this)};return a.createElement(a.Fragment,null,a.createElement("video",m({autoPlay:!0,disablePictureInPicture:f,src:s.src,muted:!b,playsInline:!0,ref:function(z){e.video=z},style:I},S)),h&&h(E))},n.defaultProps={audio:!1,disablePictureInPicture:!1,forceScreenshotSourceSize:!1,imageSmoothing:!0,mirrored:!1,onUserMedia:function(){},onUserMediaError:function(){},screenshotFormat:"image/webp",screenshotQuality:.92},n})(a.Component);x.default=N}),react:(function(v,x){v.exports=y})}).default})})(_)),_.exports}var X=B();const D=W(X),re=()=>{const M=q(),k=g.useRef(null),[y,v]=g.useState(null),[x,d]=g.useState(!1),[a,o]=g.useState(null),{profile:m}=F(),[j,w]=g.useState("environment"),[N,p]=g.useState(null),[n,e]=g.useState(null);g.useEffect(()=>{(async()=>{if(!m?.tenant_id)return;const{data:c}=await U.from("tenants").select("ai_api_key").eq("id",m.tenant_id).single();c&&p(c.ai_api_key)})()},[m?.tenant_id]);const r=()=>{w(l=>l==="user"?"environment":"user")},s=g.useCallback(()=>{const l=k.current?.getScreenshot();l&&(v(l),i(l))},[k,N]),i=async l=>{if(!N){e("AI API Key not configured. Please add it in Settings.");return}d(!0),e(null);try{const c=await H(N,l);o(c)}catch(c){console.error(c),e("Failed to analyze image. Please try again or check your API key.")}finally{d(!1)}},b=()=>{v(null),o(null),e(null)},f={facingMode:j,width:1280,height:720},u=async()=>{if(a?.licensePlate&&a.licensePlate!=="Unknown"){const{data:l}=await U.from("vehicles").select("id").eq("license_plate",a.licensePlate).single();l?M("/jobs",{state:{vehicleId:l.id,initialPlate:a.licensePlate}}):(alert("Vehicle not found in database. Create the customer and vehicle first."),M("/customers",{state:{initialPlate:a.licensePlate,make:a.make,model:a.model}}))}};return t.jsx("div",{className:"p-2 h-[calc(100vh-100px)] flex flex-col items-center justify-center",children:t.jsxs("div",{className:"max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8",children:[t.jsx("div",{className:"bg-black rounded-3xl overflow-hidden aspect-video relative border-4 border-slate-800 shadow-2xl",children:y?t.jsxs("div",{className:"relative w-full h-full group",children:[t.jsx("img",{src:y,alt:"Captured",className:"w-full h-full object-cover"}),t.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"}),t.jsx("button",{onClick:b,className:"absolute top-6 right-6 p-4 bg-black/60 text-white rounded-full hover:bg-black/80 transition-all backdrop-blur-md border border-white/20 shadow-xl",children:t.jsx(T,{size:24})})]}):t.jsxs(t.Fragment,{children:[t.jsx(D,{audio:!1,ref:k,screenshotFormat:"image/jpeg",videoConstraints:f,className:"w-full h-full object-cover"}),t.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:t.jsxs("div",{className:"w-72 h-44 border-2 border-brand/30 rounded-2xl relative",children:[t.jsx("div",{className:"absolute -top-1 -left-1 w-8 h-8 border-t-4 border-l-4 border-brand rounded-tl-xl shadow-[0_0_15px_var(--brand-soft)]"}),t.jsx("div",{className:"absolute -top-1 -right-1 w-8 h-8 border-t-4 border-r-4 border-brand rounded-tr-xl shadow-[0_0_15px_var(--brand-soft)]"}),t.jsx("div",{className:"absolute -bottom-1 -left-1 w-8 h-8 border-b-4 border-l-4 border-brand rounded-bl-xl shadow-[0_0_15_var(--brand-soft)]"}),t.jsx("div",{className:"absolute -bottom-1 -right-1 w-8 h-8 border-b-4 border-r-4 border-brand rounded-br-xl shadow-[0_0_15px_var(--brand-soft)]"}),t.jsx("div",{className:"absolute -top-8 left-1/2 -translate-x-1/2 text-brand text-[10px] font-black uppercase tracking-widest bg-slate-900/80 px-3 py-1 rounded-full border border-brand/30 backdrop-blur-sm",children:"Scan License Plate"})]})}),t.jsxs("div",{className:"absolute bottom-6 left-0 right-0 flex items-center justify-center gap-6",children:[t.jsx("button",{onClick:r,className:"p-3 bg-slate-900/80 text-white rounded-full hover:bg-slate-800 transition-all border border-slate-700 backdrop-blur-md",title:"Switch Camera",children:t.jsx(V,{size:24})}),t.jsx("button",{onClick:s,className:"w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-[0_0_30px_rgba(255,255,255,0.3)] hover:scale-110 transition-all active:scale-90 group",children:t.jsx("div",{className:"w-16 h-16 rounded-full border-4 border-slate-100 flex items-center justify-center group-hover:bg-slate-50 transition-colors",children:t.jsx(P,{size:32,className:"text-slate-900"})})}),t.jsx("div",{className:"w-12 h-12"})," "]})]})}),t.jsxs("div",{className:"flex flex-col justify-center",children:[t.jsxs("div",{className:"mb-8 text-left",children:[t.jsxs("div",{className:"inline-flex items-center gap-2 px-3 py-1 bg-brand-soft border border-brand/20 rounded-full mb-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full bg-brand animate-pulse"}),t.jsx("span",{className:"text-[10px] font-black text-brand uppercase tracking-widest",children:"Active Intelligence"})]}),t.jsxs("h1",{className:"text-5xl font-black text-white mb-2 leading-none",children:["Smart",t.jsx("span",{className:"text-brand",children:"Scan"})]}),t.jsx("p",{className:"text-slate-400 font-medium",children:"Automatic recognition and database lookup."})]}),n&&t.jsxs("div",{className:"mb-6 p-4 bg-rose-500/10 border border-rose-500/20 rounded-2xl flex items-start gap-3 text-rose-400",children:[t.jsx(L,{size:20,className:"flex-shrink-0"}),t.jsx("p",{className:"text-sm font-medium",children:n})]}),y?x?t.jsxs("div",{className:"flex flex-col items-center justify-center p-16 bg-slate-900 border border-slate-800 rounded-3xl relative overflow-hidden",children:[t.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-brand animate-[loading_2s_ease-in-out_infinite]"}),t.jsx(Q,{size:64,className:"text-brand animate-spin mb-6"}),t.jsx("p",{className:"text-brand font-mono text-xl font-black animate-pulse tracking-tighter uppercase italic text-center",children:"Analyzing Vehicle Data..."})]}):a?t.jsxs("div",{className:"bg-slate-900 border border-slate-800 rounded-3xl p-8 shadow-2xl relative overflow-hidden animate-fade-in-up",children:[t.jsx("div",{className:"absolute top-0 right-0 p-8 opacity-5",children:t.jsx(C,{size:120,className:"text-emerald-500"})}),t.jsxs("div",{className:"flex items-center gap-3 mb-8 pb-4 border-b border-white/5",children:[t.jsx("div",{className:"w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center",children:t.jsx(C,{size:20,className:"text-emerald-400"})}),t.jsxs("div",{children:[t.jsx("span",{className:"text-emerald-400 text-xs font-black uppercase tracking-widest",children:"Match Found"}),t.jsx("div",{className:"text-white font-bold leading-none",children:"Vehicle Identified"})]})]}),t.jsxs("div",{className:"space-y-8",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] block mb-2",children:"License Plate"}),t.jsx("div",{className:"text-4xl font-black text-white tracking-widest bg-black/40 px-5 py-3 rounded-2xl border border-white/10 shadow-inner group-hover:border-cyan-500/50",children:a.licensePlate})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-8",children:[t.jsxs("div",{children:[t.jsx("label",{className:"text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] block mb-2",children:"Model Identify"}),t.jsxs("div",{className:"text-xl text-white font-bold tracking-tight",children:[a.make," ",a.model]}),t.jsxs("div",{className:"text-xs text-slate-500 font-medium",children:["Color: ",a.color]})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("label",{className:"text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] block mb-2",children:"Confidence"}),t.jsxs("div",{className:"text-xl text-emerald-400 font-black tracking-tight italic",children:[(a.confidence||.99*100).toFixed(0),"%"]})]})]}),t.jsxs("button",{onClick:u,className:"w-full btn-brand font-black py-5 rounded-2xl transition-all shadow-lg hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-3 uppercase tracking-widest shadow-brand-soft",children:[t.jsx(J,{size:24})," Create Job Card"]})]})]}):null:t.jsxs("div",{className:"p-12 border-2 border-dashed border-slate-800 rounded-3xl text-center text-slate-500 bg-slate-900/20 backdrop-blur-sm group hover:border-cyan-500/30 transition-colors cursor-pointer",onClick:s,children:[t.jsx("div",{className:"w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform",children:t.jsx(P,{size:32,className:"opacity-50 group-hover:opacity-100 transition-opacity"})}),t.jsx("p",{className:"text-lg font-bold text-slate-400 mb-1",children:"Waiting for Camera"}),t.jsx("p",{className:"text-sm opacity-60",children:"Align the license plate within the frame"})]})]})]})})};export{re as SmartScan};
